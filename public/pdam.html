<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>PDAM - Data Meter</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100 p-6">

<h1 class="text-2xl font-bold mb-6 flex items-center gap-2">
  ðŸ“Š <span>Data Meter PDAM</span>
</h1>

<!-- FILTER -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
  <select id="filterRusun" class="bg-slate-900 border border-slate-700 p-2 rounded-lg text-sm">
    <option value="">Semua Rusunawa</option>
  </select>

  <input id="filterKamar" placeholder="Cari No Kamar (ex: C3.01)"
    class="bg-slate-900 border border-slate-700 p-2 rounded-lg text-sm">

  <input type="month" id="filterBulan"
    class="bg-slate-900 border border-slate-700 p-2 rounded-lg text-sm">

  <div class="flex gap-2">
    <button onclick="applyFilter()"
      class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-semibold">
      Terapkan
    </button>
    <button onclick="resetFilter()"
      class="flex-1 bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-sm">
      Reset
    </button>
  </div>
</div>

<!-- TABLE -->
<div class="overflow-auto bg-slate-900 border border-slate-800 rounded-2xl">
<table class="w-full text-sm">
<thead class="sticky top-0 bg-slate-800 text-slate-300">
<tr>
  <th class="py-3 px-3 text-left">Rusunawa</th>
  <th class="py-3 px-3 text-left">No Kamar</th>
  <th class="py-3 px-3 text-left">Tanggal</th>
  <th class="py-3 px-3 text-right">Angka Meter</th>
  <th class="py-3 px-3 text-right">Selisih</th>
  <th class="py-3 px-3 text-center">Foto</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- PAGINATION -->
<div class="flex justify-between items-center mt-4 text-sm text-slate-300">
  <div id="info"></div>
  <div class="flex gap-2">
    <button onclick="prevPage()" class="px-3 py-1 bg-slate-800 rounded hover:bg-slate-700">Prev</button>
    <button onclick="nextPage()" class="px-3 py-1 bg-slate-800 rounded hover:bg-slate-700">Next</button>
  </div>
</div>

<!-- ================= MODAL FOTO (FIXED & CENTER) ================= -->
<div id="fotoModal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm">
  
  <div class="relative bg-slate-900 rounded-2xl p-4 max-w-4xl w-[95%] shadow-2xl">
    <button onclick="closeFoto()"
      class="absolute top-3 right-3 text-slate-400 hover:text-red-400 text-xl font-bold">
      âœ•
    </button>

    <h3 class="text-sm font-semibold text-blue-400 mb-3">
      Foto Angka Meter
    </h3>

    <div class="flex justify-center">
      <img id="fotoImg"
        class="max-h-[75vh] rounded-xl border border-slate-700 shadow-lg">
    </div>
  </div>
</div>

<script>
let allData = [];
let filteredData = [];
let page = 1;
const limit = 50;

async function loadPDAM(){
  const r = await fetch("/api/pdam?action=table");
  const j = await r.json();
  if(!j.status) return;

  allData = j.data || [];
  filteredData = allData;

  populateRusunFilter(allData);
  render();
}

function populateRusunFilter(data){
  const set = new Set(data.map(d=>d.rusunawa).filter(Boolean));
  set.forEach(r=>{
    filterRusun.innerHTML += `<option>${r}</option>`;
  });
}

function applyFilter(){
  const rusun = filterRusun.value;
  const kamar = filterKamar.value.toLowerCase();
  const bulan = filterBulan.value;

  filteredData = allData.filter(d=>{
    if(rusun && d.rusunawa !== rusun) return false;
    if(kamar && !String(d.no_kamar).toLowerCase().includes(kamar)) return false;
    if(bulan){
      const dt = new Date(d.tanggal);
      const ym = dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0");
      if(ym !== bulan) return false;
    }
    return true;
  });

  page = 1;
  render();
}

function resetFilter(){
  filterRusun.value = "";
  filterKamar.value = "";
  filterBulan.value = "";
  filteredData = allData;
  page = 1;
  render();
}

function render(){
  tbody.innerHTML = "";
  const start = (page-1)*limit;
  const slice = filteredData.slice(start, start+limit);

  slice.forEach((d,i)=>{
    const zebra = i % 2 ? "bg-slate-900" : "bg-slate-950";
    tbody.innerHTML += `
    <tr class="${zebra} hover:bg-slate-800 transition">
      <td class="px-3 py-2">${d.rusunawa}</td>
      <td class="px-3 py-2 font-semibold text-blue-400">${d.no_kamar}</td>
      <td class="px-3 py-2">${new Date(d.tanggal).toLocaleDateString("id-ID")}</td>
      <td class="px-3 py-2 text-right">${d.angka_meter}</td>
      <td class="px-3 py-2 text-right font-bold ${d.selisih_meter>0?'text-green-400':'text-slate-500'}">
        ${d.selisih_meter}
      </td>
      <td class="px-3 py-2 text-center">
        ${d.foto
          ? `<button onclick="openFoto('${d.foto}')" class="text-blue-400 underline">lihat</button>`
          : "-"}
      </td>
    </tr>`;
  });

  info.innerText =
    `Menampilkan ${start+1}-${Math.min(start+limit, filteredData.length)} dari ${filteredData.length}`;
}

function nextPage(){ if(page*limit < filteredData.length){ page++; render(); } }
function prevPage(){ if(page>1){ page--; render(); } }

function openFoto(url){
  fotoImg.src = url;
  fotoModal.classList.remove("hidden");
  fotoModal.classList.add("flex");
  document.body.style.overflow = "hidden";
}

function closeFoto(){
  fotoModal.classList.add("hidden");
  fotoModal.classList.remove("flex");
  fotoImg.src = "";
  document.body.style.overflow = "";
}

// tutup modal dengan klik backdrop
fotoModal.addEventListener("click",e=>{
  if(e.target === fotoModal) closeFoto();
});

// tutup modal dengan ESC
document.addEventListener("keydown",e=>{
  if(e.key === "Escape" && !fotoModal.classList.contains("hidden")){
    closeFoto();
  }
});

loadPDAM();
</script>

</body>
</html>
