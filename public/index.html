<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Manajemen Penghuni Rusun</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-950 text-gray-200">

<script>
if(localStorage.getItem("rusun_login")!=="true"){
  location.href="/login.html";
}
</script>

<div class="flex min-h-screen">

<!-- SIDEBAR -->
<aside class="w-64 bg-gray-900 p-5 border-r border-gray-800">
<h2 class="text-xl font-bold mb-6">üè† RUSUN DASHBOARD</h2>
<p class="text-sm text-gray-400">Manajemen Penghuni</p>
<button onclick="logout()" class="mt-10 text-red-400 text-sm">Logout</button>
</aside>

<!-- MAIN -->
<main class="flex-1 p-6">

<h1 class="text-2xl font-bold mb-6">Dashboard Internal</h1>

<!-- CARDS -->
<div id="cards" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8"></div>

<!-- TABLE -->
<div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
<h3 class="font-bold mb-3">Daftar Penghuni</h3>
<input id="search" placeholder="Cari unit / nama..."
 class="w-full p-2 mb-3 rounded bg-gray-800 border border-gray-700">

<div class="overflow-auto">
<table class="w-full text-sm" id="table"></table>
</div>
</div>

</main>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center">
<div class="bg-gray-900 w-full max-w-3xl p-6 rounded-xl border border-gray-700">
<h2 class="text-xl font-bold mb-3" id="mdTitle"></h2>
<div id="mdBody" class="text-sm"></div>
<button onclick="closeModal()" class="mt-4 bg-red-600 px-4 py-2 rounded">Tutup</button>
</div>
</div>

<script>
const API_KEY = "rusun2026"; // samakan dengan Code.gs
let penghuni=[];

function logout(){
  localStorage.removeItem("rusun_login");
  location.href="/login.html";
}

async function load(){
  const r = await fetch(`/api/data?action=internal&key=${API_KEY}`);
  const j = await r.json();
  const d = j.data;

  cards.innerHTML = `
    ${card("Penghuni", d.totalPenghuni)}
    ${card("Unit Terisi", d.unitTerisi)}
    ${card("Total Bayar", rupiah(d.totalPembayaran))}
    ${card("Total Tunggakan", rupiah(d.totalTunggakan))}
  `;

  penghuni = d.listPenghuni;
  render(penghuni);
}

function card(t,v){
  return `<div class="bg-gradient-to-br from-gray-800 to-gray-900 p-4 rounded-xl border border-gray-700">
  <div class="text-gray-400 text-sm">${t}</div>
  <div class="text-2xl font-bold">${v}</div></div>`;
}

function render(data){
  let h = `<tr class="text-left border-b border-gray-700">
<th class="p-2">Unit</th><th>Nama</th><th>Status</th><th>Total Bayar</th><th>Total Tunggakan</th></tr>`;

  data.forEach(r=>{
    h+=`<tr onclick="detail('${r.unit}')" class="border-b border-gray-800 hover:bg-gray-800 cursor-pointer">
    <td class="p-2">${r.unit}</td>
    <td>${r.penghuni.Nama||""}</td>
    <td>${r.penghuni["Kondisi Unit"]||""}</td>
    <td>${rupiah(r.totalBayar)}</td>
    <td>${rupiah(r.totalTunggakan)}</td></tr>`;
  });

  table.innerHTML=h;
}

search.addEventListener("input",e=>{
  const q=e.target.value.toLowerCase();
  render(penghuni.filter(r=>
    r.unit.toLowerCase().includes(q) ||
    (r.penghuni.Nama||"").toLowerCase().includes(q)
  ));
});

function detail(unit){
  const x = penghuni.find(p=>p.unit===unit);
  if(!x) return;

  modal.classList.remove("hidden");
  modal.classList.add("flex");

  mdTitle.innerText = "Unit "+x.unit;

  mdBody.innerHTML = `
  <div class="grid grid-cols-2 gap-4 mb-3">
    <div><b>Nama:</b><br>${x.penghuni.Nama||"-"}</div>
    <div><b>No Telp:</b><br>${x.penghuni["No Telp"]||"-"}</div>
    <div><b>Total Bayar:</b><br>${rupiah(x.totalBayar)}</div>
    <div><b>Total Tunggakan:</b><br>${rupiah(x.totalTunggakan)}</div>
  </div>

  <hr class="my-3 border-gray-700">

  <b>Riwayat Pembayaran:</b>
  <pre class="text-xs bg-gray-950 p-3 rounded overflow-auto">
${JSON.stringify(x.pembayaran,null,2)}
  </pre>

  <hr class="my-3 border-gray-700">

  <b>Data Tunggakan:</b>
  <pre class="text-xs bg-gray-950 p-3 rounded overflow-auto">
${JSON.stringify(x.tunggakan,null,2)}
  </pre>
  `;
}

function closeModal(){ modal.classList.add("hidden"); }

function rupiah(n){ return "Rp " + (n||0).toLocaleString("id-ID"); }

load();
</script>

</body>
</html>
